<div class="auth-box">
  <form
    action="/auth/register/resident"
    class="grid gap-4"
    name="register"
    method="post"
    id="register"
  >
    <table class="uk-table uk-table-divider">
      <tr>
        <td><label for="username">아이디</label></td>
        <td><input name="username" placeholder="아이디 입력" /></td>
      </tr>

      <tr>
        <td><label for="password">비밀번호</label></td>
        <td>
          <input
            name="password"
            placeholder="비밀번호 입력"
            type="password"
            value=""
            onkeyup="validatePassword(this.value)"
          />
          <p id="passwordMessage" class="error"></p>
        </td>
      </tr>

      <tr>
        <td><label for="phone">핸드폰 번호 (필수)</label></td>
        <td>
          <input
            name="phone"
            placeholder="핸드폰 번호 입력 (숫자만)"
            value="010-0000-0000"
          />
        </td>
      </tr>

      <tr>
        <td><label for="realname">실명</label></td>
        <td><input name="realname" placeholder="실명 입력" value=" " /></td>
      </tr>

      <tr>
        <td><label for="email">본인 확인 이메일 (필수)</label></td>
        <td><input id="email" placeholder="이메일 입력" type="email" value="" /></td>
      </tr>

      <tr
        id="verificationCodeContainer"
        class="grid gap-2"
        style="display: none"
      >
        <td><label for="verificationCode">이메일 인증 코드</label></td>
        <td>
            <input
              id="verificationCode"
              name="verificationCode"
              placeholder="인증 코드 입력"
            />
        </td>
      </tr>

      <tr>
        <td>
          <button class="uk-button uk-button-default" onclick="sendVerificationEmail()" type="button">
            이메일 인증 코드 전송
          </button>
        </td>
        <td>
          <button class="uk-button uk-button-default" onclick="verifyEmail()" type="button" style="display: none">
            이메일 인증 확인 하기
          </button>
          <div id="verificationStatus"></div>
        </td>
      </tr>
      <tr>
        <td>
          <label
            >생년월일 (선택) <br />
            <input
              type="date"
              name="bday"
              required
              pattern="\d{4}-\d{2}-\d{2}"
              value=""
            />
            <span class="validity"></span>
          </label>
        </td>

        <!-- <label for="birth">생년월일 (선택)</label>
        <input name="birth" placeholder="생년월일 입력" value="19980412" /> -->
      </tr>
      <br />
      <br />
    </form>
  </table>
</div>

<button class="uk-button uk-button-default" type="submit" form="register">회원가입</button>

<script>
  function validatePassword(password) {
    const passwordMessage = document.getElementById("passwordMessage");

    const minLength = 8;
    const hasUppercase = /[A-Z]/.test(password);
    const hasLowercase = /[a-z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    const hasSpecial = /^(?=.*[!@#%&])/.test(password);

    if (password.length < minLength) {
      passwordMessage.innerText = `비밀번호는 ${minLength}자 이상이어야 합니다.`;
    } else if (!hasUppercase) {
      passwordMessage.innerText = "비밀번호에는 대문자가 포함되어야 합니다.";
    } else if (!hasLowercase) {
      passwordMessage.innerText = "비밀번호에는 소문자가 포함되어야 합니다.";
    } else if (!hasNumber) {
      passwordMessage.innerText = "비밀번호에는 숫자가 포함되어야 합니다.";
    } else if (!hasSpecial) {
      passwordMessage.innerText = "비밀번호에는 특수기호가 포함되어야 합니다";
    } else {
      passwordMessage.innerText = "";
    }
  }

  async function sendVerificationEmail() {
    const emailElement = document.getElementById("email");
    await fetch("/auth/certification", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ email: emailElement.value }),
    });

    const verificationCodeContainer = document.getElementById(
      "verificationCodeContainer"
    );
    const verificationCodeElement = document.getElementById("verificationCode");
    const verifyEmailButton = document.querySelector(
      "button[onclick='verifyEmail()']"
    );

    // const activationCode = await generateActivationCode();

    // console.log("Activation Code:", activationCode);

    // verificationCodeElement.value = activationCode;

    verificationCodeContainer.style.display = "grid";
    verifyEmailButton.style.display = "block";
  }

  async function verifyEmail() {
    const emailElement = document.getElementById("email");
    const verificationCodeElement = document.getElementById("verificationCode");

    const result = await fetch("/auth/certification-check", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        email: emailElement.value,
        code: verificationCodeElement.value,
      }),
    });

    // const storedVerificationCode = verificationCodeElement.value.trim();
    // const userVerificationCode = prompt(
    //   "Enter the verification code from your email:"
    // );

    const verificationStatusElement =
      document.getElementById("verificationStatus");

    if (result.status === 200) {
      verificationStatusElement.innerText = "이메일 인증이 완료되었습니다.";
      verificationStatusElement.style.color = "green";
    } else {
      verificationStatusElement.innerText = "이메일 인증이 실패했습니다.";
      verificationStatusElement.style.color = "red";
    }
  }
</script>
