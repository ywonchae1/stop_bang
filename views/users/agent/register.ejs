<div class="auth-box">
  <h2 class="auth-align-center">ğŸ¦ê³µì¸ì¤‘ê°œì‚¬ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!ğŸ¦</h2>
  <form
    action="/auth/register/agent"
    name="register"
    method="post"
    id="register"
  >
    <table class="uk-table uk-table-divider">
      <tr>
        <td style="width:40%"><label for="username">ì•„ì´ë””</label></td>
        <td><input class="uk-input" name="username" placeholder="ì•„ì´ë”” ì…ë ¥" /></td>
      </tr>

      <tr>
        <td><label for="password">ë¹„ë°€ë²ˆí˜¸</label></td>
        <td>
          <input
            class="uk-input"
            name="password"
            placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
            type="password"
            value="password!A"
            onkeyup="validatePassword(this.value)"
          />
          <p id="passwordMessage" class="error"></p>
        </td>
      </tr>

      <tr>
        <td><label for="phone">í•¸ë“œí° ë²ˆí˜¸ (í•„ìˆ˜)</label></td>
        <td>
          <input
            class="uk-input"
            oninput="autoHyphen2(this)"
            maxlength="13"
            id="residentPhone"
            name="phone"
            placeholder="010-0000-0000"
          />
        </td>
      </tr>

      <tr>
        <td><label for="realname">ì‹¤ëª…</label></td>
        <td><input class="uk-input" name="realname" placeholder="ì‹¤ëª… ì…ë ¥" /></td>
      </tr>

      <tr>
        <td><label for="agentList_ra_regno">raregno</label></td>
        <td>
          <input
            class="uk-input"
            id="agentList_ra_regno"
            name="agentList_ra_regno"
            placeholder="111-33-4444"
          />
        </td>
      </tr>

      <tr>
        <td>
          <button class="uk-button uk-button-default" onclick="getAgentPhoneNumber()" type="button">
            í•¸ë“œí° ë²ˆí˜¸ ë¶ˆëŸ¬ì˜¤ê¸°
          </button>
        </td>

        <td><p id="agent_phone_number"></p></td>
      </tr>

      <tr>
        <td><label for="email">ë³¸ì¸ í™•ì¸ ì´ë©”ì¼ (í•„ìˆ˜)</label></td>
        <td><input class="uk-input" id="email" placeholder="ì´ë©”ì¼ ì…ë ¥" type="email" value="" /></td>
      </tr>

      <tr>
        <td><label for="verificationCode">ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ</label></td>
        <td>
          <input
            class="uk-input"
            id="verificationCode"
            name="verificationCode"
            placeholder="ì¸ì¦ ì½”ë“œ ì…ë ¥"
          />
        </td>
      </tr>

      <tr>
        <td>
          <button class="uk-button uk-button-default" onclick="sendVerificationEmail()" type="button">
            ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ ì „ì†¡
          </button>
        </td>

        <td>
          <button class="uk-button uk-button-default" onclick="verifyEmail()" type="button" style="display: none">
            ì´ë©”ì¼ ì¸ì¦ í™•ì¸ í•˜ê¸°
          </button>
          <div id="verificationStatus"></div>
        </td>
      </tr>

      <tr>
        <td><label>ìƒë…„ì›”ì¼ (ì„ íƒ)</label></td>
        <td>
          <input
            class="uk-input"
            type="date"
            name="bday"
            required
            pattern="\d{4}-\d{2}-\d{2}"
            value="1999-11-11"
          />
          <span class="validity"></span>
        </td>
        </label>

        <!-- <label for="birth">ìƒë…„ì›”ì¼ (ì„ íƒ)</label>
        <input name="birth" placeholder="ìƒë…„ì›”ì¼ ì…ë ¥" value="19980412" /> -->
      </tr>
      <tr>
        <td colspan="2" align="center"><button class="uk-button uk-button-default" type="submit" form="register">íšŒì›ê°€ì…</button></td>
      </tr>
    </form>
  </table>
</div>

<script>
  const autoHyphen2 = (target) => {
    target.value = target.value
      .replace(/[^0-9]/g, '')
      .replace(/^(\d{0,3})(\d{0,4})(\d{0,4})$/g, "$1-$2-$3").replace(/(\-{1,2})$/g, "");
  }

  function validatePassword(password) {
    const passwordMessage = document.getElementById("passwordMessage");

    const minLength = 8;
    const hasUppercase = /[A-Z]/.test(password);
    const hasLowercase = /[a-z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    const hasSpecial = /^(?=.*[!@#%&])/.test(password);

    if (password.length < minLength) {
      passwordMessage.innerText = `ë¹„ë°€ë²ˆí˜¸ëŠ” ${minLength}ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`;
    } else if (!hasUppercase) {
      passwordMessage.innerText = "ë¹„ë°€ë²ˆí˜¸ì—ëŠ” ëŒ€ë¬¸ìê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.";
    } else if (!hasLowercase) {
      passwordMessage.innerText = "ë¹„ë°€ë²ˆí˜¸ì—ëŠ” ì†Œë¬¸ìê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.";
    } else if (!hasNumber) {
      passwordMessage.innerText = "ë¹„ë°€ë²ˆí˜¸ì—ëŠ” ìˆ«ìê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.";
    } else if (!hasSpecial) {
      passwordMessage.innerText = "ë¹„ë°€ë²ˆí˜¸ì—ëŠ” íŠ¹ìˆ˜ê¸°í˜¸ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤";
    } else {
      passwordMessage.innerText = "";
    }
  }

  async function getAgentPhoneNumber() {
    const raRegnoElement = document.getElementById("agentList_ra_regno");

    const response = await fetch(
      `/agent/phoneNumber?raRegno=${raRegnoElement.value}`
    );
    const result = await response.json();

    if (!result.phoneNumber)
      return alert("Failed to get a phone number of agent");

    const agentPhoneNumberElement =
      document.getElementById("agent_phone_number");

    agentPhoneNumberElement.innerText = result.phoneNumber;
  }

  async function generateActivationCode() {
    const response = await fetch("/randomBytes?length=16");
    const randomBytes = await response.arrayBuffer();
    const hexString = Array.from(new Uint8Array(randomBytes))
      .map((byte) => byte.toString(16).padStart(2, "0"))
      .join("");

    return hexString;
  }

  async function sendVerificationEmail() {
    const emailElement = document.getElementById("email");
    await fetch("/auth/certification", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ email: emailElement.value }),
    });

    const verificationCodeContainer = document.getElementById(
      "verificationCodeContainer"
    );
    const verificationCodeElement = document.getElementById("verificationCode");
    const verifyEmailButton = document.querySelector(
      "button[onclick='verifyEmail()']"
    );

    // const activationCode = await generateActivationCode();

    // console.log("Activation Code:", activationCode);

    // verificationCodeElement.value = activationCode;

    verificationCodeContainer.style.display = "grid";
    verifyEmailButton.style.display = "block";
  }

  async function verifyEmail() {
    const emailElement = document.getElementById("email");
    const verificationCodeElement = document.getElementById("verificationCode");

    const result = await fetch("/auth/certification-check", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        email: emailElement.value,
        code: verificationCodeElement.value,
      }),
    });

    // const storedVerificationCode = verificationCodeElement.value.trim();
    // const userVerificationCode = prompt(
    //   "Enter the verification code from your email:"
    // );

    const verificationStatusElement =
      document.getElementById("verificationStatus");

    if (result.status === 200) {
      verificationStatusElement.innerText = "ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
      verificationStatusElement.style.color = "green";
    } else {
      verificationStatusElement.innerText = "ì´ë©”ì¼ ì¸ì¦ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
      verificationStatusElement.style.color = "red";
    }
  }
</script>
